<html>
<body>
<style>
    video {
        width: 300px;
        height: 300px;
    }
</style>
<h1>Me</h1>
<video id="me" autoplay></video>

<h1>Remote</h1>
<video id="remote" autoplay></video>
<script src="vendor/simplepeer.min.js"></script>
<script>
    window.Peer = window.SimplePeer;

    // Create WebSocket connection.
    const socket = new WebSocket('ws://localhost:8888');

    let clientId;

    // Connection opened
    socket.addEventListener('open', function () {
        socket.send({
            topic: 'CLIENT_CONNECTED',
        });
    });

    // Listen for messages
    socket.addEventListener('message', function (event) {
        console.log('got WS message', event.data);
        let message;

        try {
            message = JSON.parse(event.data);
        } catch (err) {
            console.error('Could not parse JSON! got:', event.data);
            return;
        }

        if (message.topic === 'initiateWebRTC') {
            console.log('Initiating WebRTC');

            clientId = message.content.id;

            // get video/voice stream
            navigator.getUserMedia(
                {
                    video: true,
                    audio: true
                },
                (stream) => {
                    initWebRTC(stream, {
                        initiator:  message.content.initiator,
                    })
                },
                (err) => {
                    console.error('getUserMedia failed', err);
                });
            return;
        }

        if (message.topic === 'webRTCOffer' && message.clientAuthorId !== clientId) {
            console.log('Signaling offer');
            p.signal(message.content);
            return;
        }

        if (message.topic === 'webRTCAnswer' && message.clientAuthorId !== clientId) {
            console.log('Signaling answer');
            p.signal(message.content);
            return;
        }
    });

    function initWebRTC (stream, { initiator }) {
        document.querySelector('#me').srcObject = stream;

        window.p = new Peer({
            initiator: initiator,
            trickle: false,
            stream: stream,
        });

        p.on('signal', data => {
            console.log('Peer signal');
            if (initiator) {
                console.log('Sending offer to WS');

                socket.send(JSON.stringify({
                    topic: 'webRTCOffer',
                    content: JSON.stringify(data),
                    id: clientId,
                }, null, 2));
            } else {
                console.log('Sending answer to WS');

                socket.send(JSON.stringify({
                    topic: 'webRTCAnswer',
                    content: JSON.stringify(data),
                    id: clientId,
                }, null, 2));
            }
        });

        p.on('connect', () => {
            console.log('CONNECT');
            p.send('whatever' + Math.random());
        });

        p.on('stream', remoteStream => {
            // got remote video stream, now let's show it in a video tag
            var video = document.querySelector('#remote');

            video.srcObject = remoteStream;

            video.play()
        })
    }
</script>
</body>
</html>